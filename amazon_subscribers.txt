CREATE TABLE subscribers (
  customer_id INT,
  subscription_date DATE,
  plan_value INT
);

INSERT INTO subscribers VALUES
(1, '2023-03-02', 799),
(1, '2023-04-01', 599),
(1, '2023-05-01', 499),
(2, '2023-04-02', 799),
(2, '2023-07-01', 599),
(2, '2023-09-01', 499),
(3, '2023-01-01', 499),
(3, '2023-04-01', 599),
(3, '2023-07-02', 799),
(4, '2023-04-01', 499),
(4, '2023-09-01', 599),
(4, '2023-10-02', 499),
(4, '2023-11-02', 799),
(5, '2023-10-02', 799),
(5, '2023-11-02', 799),
(6, '2023-03-01', 499);



Q. Find the Count of Distinct Customers


Expected Output

unique_customers
6

Solution

SELECT 
	COUNT(DISTINCT customer_id) AS unique_customers
FROM subscribers



Q. Calculate Minimum Spend and Maximum Spend amount of each customer


Expected Output 

customer_id	min_spend	max_spend
1			499			799
2			499			799
3			499			799
4			499			799
5			799			799
6			499			499


Solution

SELECT 
	customer_id,
	MIN(plan_value) AS min_spend,
	MAX(plan_value) AS max_spend
FROM subscribers
GROUP BY customer_id


Q. Write a query to find customers (i) who have upgraded atleast once in their lifetime (ii) who have upgraded atleast once in their lifetime 


Expected Output

customer_id		has_upgraded	has_downgraded
1				No				Yes
2				No				Yes
3				Yes				No
4				Yes				Yes
5				No				No
6				No				No

Solution

WITH cte AS (
SELECT
	*, 
	LAG(plan_value,1, plan_value) OVER(PARTITION BY customer_id ORDER BY customer_id, subscription_date) AS prev_plan_value
FROM subscribers
), cte2 AS (
SELECT 
	customer_id,
	MAX(CASE WHEN plan_value > prev_plan_value THEN 1 ELSE 0 END) AS flag_up,
	MAX(CASE WHEN plan_value < prev_plan_value THEN 1 ELSE 0 END) AS flag_down
FROM cte
GROUP BY customer_id
)
SELECT 
	customer_id,
	CASE WHEN flag_up > 0 THEN 'Yes' ELSE 'No' END AS has_upgraded,
	CASE WHEN flag_down > 0 THEN 'Yes' ELSE 'No' END AS has_downgraded
FROM cte2